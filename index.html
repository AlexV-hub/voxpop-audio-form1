// Configuration
const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycby2qX7_YLIouSJg_v4Vdf6wFU8V5hX9WBymOyy1MbQfPKThNJauihRc9MKUE9d6V68Qrg/exec';

// Questions data
const questionsData = [
    { id: 1, question: "Nom, Prénom", type: "Voice recording or Short text" },
    { id: 2, question: "Adresse email dédiée au projet ?", type: "Short text" },
    { id: 3, question: "Pourquoi revenir sur le marché HoReCa maintenant ? Quel(s) progrès technologique précis t'y a poussé ?", type: "Voice recording ou Short text" },
    { id: 4, question: "Quel(s) problem(s) concret(s) veut résoudre Vox-Pop! pour les restaurateurs ?", type: "Voice recording ou Short text" },
    { id: 5, question: "Quelles sont les 3 fonctionnalités clés du produit au stade MVP?", type: "Voice recording ou Short text" },
    { id: 6, question: "Quel est le modèle économique prévu ? (Saas, Freemium, Commission, Renting etc)", type: "Voice recording ou Short text" },
    { id: 7, question: "Quelle est la cible prioritaire en phase pilote et dans les 3 mois du lancement ? Et Pourquoi ?", type: "Voice recording ou Short text" },
    { id: 8, question: "Quels sont les 2 ou 3 plus grands risques identifiés à ce stade?", type: "Voice recording ou Short text" },
    { id: 9, question: "Quels sont les principaux concurrents identifiés par zone EMEA, NA, APAC, LATAM ?", type: "Voice recording ou Short text" },
    { id: 10, question: "Quelle serait la preuve irréfutable de succès dans 1 an, 2ans, 3ans ?", type: "Voice recording ou Short text" },
    { id: 11, question: "Autorises-tu que cet enregistrement soit traité automatiquement ?", type: "Yes / No" }
];

// État de l'application
let currentQuestion = 0;
let responses = {};
let responseMode = 'text'; // 'text' ou 'audio'
let isRecording = false;
let isPaused = false;
let audioBlob = null;
let audioValidated = false;
let recordingTime = 0;
let recordingTimer = null;
let mediaRecorder = null;
let audioStream = null;
let audioChunks = [];

// Éléments DOM
const welcomeScreen = document.getElementById('welcome-screen');
const questionnaireScreen = document.getElementById('questionnaire-screen');
const completionScreen = document.getElementById('completion-screen');
const loadingOverlay = document.getElementById('loading-overlay');

// Éléments de contrôle
const startBtn = document.getElementById('start-btn');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const restartBtn = document.getElementById('restart-btn');

// Éléments de question
const questionText = document.getElementById('question-text');
const questionType = document.getElementById('question-type');
const progressText = document.getElementById('progress-text');
const progressPercent = document.getElementById('progress-percent');
const progressFill = document.getElementById('progress-fill');

// Éléments de réponse
const responseSelector = document.getElementById('response-selector');
const textModeBtn = document.getElementById('text-mode-btn');
const audioModeBtn = document.getElementById('audio-mode-btn');
const textResponse = document.getElementById('text-response');
const yesnoResponse = document.getElementById('yesno-response');
const audioResponse = document.getElementById('audio-response');
const textInput = document.getElementById('text-input');
const yesBtn = document.getElementById('yes-btn');
const noBtn = document.getElementById('no-btn');

// Éléments audio
const recordingStatus = document.getElementById('recording-status');
const statusDot = document.getElementById('status-dot');
const statusText = document.getElementById('status-text');
const recordingTimerEl = document.getElementById('recording-timer');
const startRecordingBtn = document.getElementById('start-recording-btn');
const activeControls = document.getElementById('active-controls');
const pauseBtn = document.getElementById('pause-btn');
const resumeBtn = document.getElementById('resume-btn');
const stopBtn = document.getElementById('stop-btn');
const playbackSection = document.getElementById('playback-section');
const playBtn = document.getElementById('play-btn');
const pausePlaybackBtn = document.getElementById('pause-playback-btn');
const audioDuration = document.getElementById('audio-duration');
const deleteBtn = document.getElementById('delete-btn');
const continueBtn = document.getElementById('continue-btn');
const validateBtn = document.getElementById('validate-btn');
const validatedStatus = document.getElementById('validated-status');
const audioPlayer = document.getElementById('audio-player');

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    setupEventListeners();
});

function initializeApp() {
    showWelcomeScreen();
}

function setupEventListeners() {
    // Navigation
    startBtn.addEventListener('click', startQuestionnaire);
    prevBtn.addEventListener('click', previousQuestion);
    nextBtn.addEventListener('click', nextQuestion);
    restartBtn.addEventListener('click', restartQuestionnaire);

    // Mode de réponse
    textModeBtn.addEventListener('click', () => setResponseMode('text'));
    audioModeBtn.addEventListener('click', () => setResponseMode('audio'));

    // Réponse texte
    textInput.addEventListener('input', handleTextInput);

    // Réponse Oui/Non
    yesBtn.addEventListener('click', () => handleYesNoResponse('Oui'));
    noBtn.addEventListener('click', () => handleYesNoResponse('Non'));

    // Contrôles audio
    startRecordingBtn.addEventListener('click', startRecording);
    pauseBtn.addEventListener('click', pauseRecording);
    resumeBtn.addEventListener('click', resumeRecording);
    stopBtn.addEventListener('click', stopRecording);
    playBtn.addEventListener('click', playRecording);
    pausePlaybackBtn.addEventListener('click', pausePlayback);
    deleteBtn.addEventListener('click', deleteRecording);
    continueBtn.addEventListener('click', continueRecording);
    validateBtn.addEventListener('click', validateRecording);

    // Audio player events
    audioPlayer.addEventListener('ended', () => {
        playBtn.classList.remove('hidden');
        pausePlaybackBtn.classList.add('hidden');
    });
}

// Navigation entre écrans
function showWelcomeScreen() {
    welcomeScreen.classList.remove('hidden');
    questionnaireScreen.classList.add('hidden');
    completionScreen.classList.add('hidden');
}

function showQuestionnaireScreen() {
    welcomeScreen.classList.add('hidden');
    questionnaireScreen.classList.remove('hidden');
    completionScreen.classList.add('hidden');
}

function showCompletionScreen() {
    welcomeScreen.classList.add('hidden');
    questionnaireScreen.classList.add('hidden');
    completionScreen.classList.remove('hidden');
}

function startQuestionnaire() {
    currentQuestion = 0;
    responses = {};
    showQuestionnaireScreen();
    displayQuestion();
}

function restartQuestionnaire() {
    currentQuestion = 0;
    responses = {};
    responseMode = 'text';
    resetAudioState();
    showWelcomeScreen();
}

// Gestion des questions
function displayQuestion() {
    const question = questionsData[currentQuestion];
    
    // Mise à jour du contenu
    questionText.textContent = question.question;
    questionType.textContent = question.type;
    
    // Mise à jour de la progression
    const progress = ((currentQuestion + 1) / questionsData.length) * 100;
    progressText.textContent = `Question ${currentQuestion + 1} sur ${questionsData.length}`;
    progressPercent.textContent = `${Math.round(progress)}%`;
    progressFill.style.width = `${progress}%`;
    
    // Configuration de l'interface de réponse
    setupResponseInterface(question);
    
    // Mise à jour des boutons de navigation
    updateNavigationButtons();
    
    // Charger la réponse précédente si elle existe
    loadPreviousResponse();
}

function setupResponseInterface(question) {
    // Masquer toutes les sections
    textResponse.classList.add('hidden');
    yesnoResponse.classList.add('hidden');
    audioResponse.classList.add('hidden');
    responseSelector.classList.add('hidden');
    
    // Reset des boutons de mode
    textModeBtn.classList.remove('active');
    audioModeBtn.classList.remove('active');
    
    if (question.type === "Short text") {
        textResponse.classList.remove('hidden');
        responseMode = 'text';
    } else if (question.type === "Yes / No") {
        yesnoResponse.classList.remove('hidden');
        responseMode = 'yesno';
    } else {
        // Question avec choix audio/texte
